/*! waterfallx - v1.0 - 2013-06-14 4:52:36 PM
* Copyright (c) 2013 踏风; Licensed  */
KISSY.add("gallery/waterfallx/1.0/base",function(a,b,c){function d(b,c,d,e){var f,g={},h=0;return b.length>h?f=setTimeout(function(){var a=+new Date;do{var g=b[h++];c.call(d,g)}while(b.length>h&&+new Date-a<50);b.length>h?f=setTimeout(arguments.callee,25):e&&e.call(d,b)},25):e&&a.later(e,0,!1,d,b),g.stop=function(){clearTimeout(f)},g}function e(a,b,c){if(!a)return b&&b(),void 0;var d=this,e=d.config.effect,f=this._items,g="append",i=h(a),j=d._colItems,k=j.length,l=Number.MAX_VALUE,m=0;if(c?"preadd"==c&&(f=this._preItems,g="prepend",f.push(i),i.attr("data-waterfall-index",-f.length)):i.attr("data-waterfall-index",f.length)&&f.push(i),i.hasClass("ks-waterfall-fixed-left"))m=0;else if(i.hasClass("ks-waterfall-fixed-right"))m=k>0?k-1:0;else for(var n=0;k>n;n++){var o=j[n].outerHeight(!0);l>o&&(l=o,m=n)}return e&&e.effect?(j[m][g](i),i.hide(),b&&b(),i[e.effect](e.duration,0,e.easing)):(j[m][g](i),b&&b()),i}function f(){var a=this._containerRegion;if(!a||this.container.width()!==a)return this._calculate()===this._colItems.length?(this._adjustMargin(),void 0):(this.adjust(),void 0)}function g(b){if(b.container){var c={align:"center",minColCount:1,effect:{effect:"fadeIn",duration:1}};this.config=a.merge(c,b),this.container=h(b.container),this._colItems=[],this._preItems=[],this._items=[],this._init()}}var h=b.all,i=a.Env.host||window,j=i.document,k="ks-waterfall-col",l=50,m="."+k+"{ display: inline-block; vertical-align:top;"+"*display: inline; *zoom: 1}",n={_init:function(){c.addStyleSheet(m,"ks-waterfallx"),this._createColumnItems(),this.addItems(this.container.all(".ks-waterfall")),this.__onResize=a.buffer(f,l,this),h(i).on("resize",this.__onResize)},_calculate:function(){var a,b=this.config,c=this.container,d=c.width();return b.colWidth||(b.colWidth=d),a=Math.max(parseInt(d/b.colWidth),b.minColCount),this._containerRegion=d,a},_createColumnItems:function(){for(var a=this.config,b=this._colItems,c=this._calculate(),d=b.length-1;d>-1;--d)b[d].remove();for(b.length=c,d=0;c>d;++d)b[d]=h(j.createElement("div")).addClass(k).appendTo(this.container),b[d].width(a.colWidth);this._adjustMargin()},_adjustMargin:function(){var a=this.config,b=a.align,c=this._colItems,d=c.length,e="left"===b?0:Math.max(this.container.width()-d*a.colWidth,0);"center"===b&&(e/=2),c[0].css("marginLeft",e+"px")},_deleteItem:function(a){var b=+a.attr("data-waterfall-index");0>b?(b=-(b+1),this._preItems[b]=null):this._items[b]=null}},o={addItems:function(a,b){var c=this;return c._adder=d(a,e,c,function(){c._adder=0,b&&b.call(c),c.fire("addComplete",{items:a})}),c._adder},preAddItems:function(a,b){var c=this;return c._adder=d(a,function(a){e.call(c,a,null,"preadd")},c,function(){c._adder=0,b&&b.call(c),c.fire("addComplete",{items:a})}),c._adder},isAdding:function(){return!!this._adder},removeItem:function(a,b){b=b||{},a=h(a);var c=b.effect,d=this,e=function(){d._deleteItem(a),a.remove(),b.callback&&b.callback.call(d)};c?a.animate(c.effect,c.duration,c.easing,e):e()},destroy:function(){h(i).detach("resize",this.__onResize)},isAdjusting:function(){return!!this._adjuster},adjust:function(b){function c(){--k,0>=k&&(f._adjuster=0,b&&b.call(f),f.fire("adjustComplete",{items:g}))}a.log("waterfall:adjust");var f=this,g=this._items=this._preItems.concat(this._items);f.isAdjusting()&&(f._adjuster.stop(),f._adjuster=0),this._preItems=[];for(var i=0,j=g.length;j>i;)g[i]?h(g[i]).stop(!0).attr("data-waterfall-index",i++):(g.splice(i,1),--j);f._createColumnItems();var k=g.length;return f._adjuster=d(g,function(a){e.call(f,a,c,!0)})},adjustItem:function(){}};return a.augment(g,a.Event.Target,n,o),g},{requires:["node","dom"]}),KISSY.add("gallery/waterfallx/1.0/loader",function(a,b,c){function d(){d.superclass.constructor.apply(this,arguments),this.config.diff||(this.config.diff=0)}function e(){var b=this;if(a.log("waterfall:doScroll"),!b.__loading&&b.__started){if(b.isAdjusting())return b.__onScroll(),void 0;var c=b.config.diff;c+g(h).scrollTop()+g(h).height()>b.container.outerHeight(!0)&&(a.log("waterfall:loading"),f.call(b))}}function f(){function a(a,b){c.__loading=0,c.addItems(a,b)}function b(){c.end()}var c=this;c.__loading=1;var d=c.config.load;d&&d(a,b)}var g=b.all,h=a.Env.host||window,i=50;return a.extend(d,c,{_init:function(){var b=this;d.superclass._init.apply(b,arguments),b.__onScroll=a.buffer(e,i,b),b.__onScroll(),b.start()},start:function(){!this.__started&&g(h).on("scroll",this.__onScroll)&&(this.__started=1)},end:function(){g(h).detach("scroll",this.__onScroll),this.__started=0},pause:function(){this.end()},resume:function(){this.start()},destroy:function(){var a=this;d.superclass.destroy.apply(a,arguments),g(h).detach("scroll",a.__onScroll),a.__started=0}}),d},{requires:["node","./base"]}),KISSY.add("gallery/waterfallx/1.0/index",function(a,b,c){return b.Loader=c,b},{requires:["./base","./loader"]});